# RESTful interface to the DCC DocDB tables in MySQL

This package implements a simple RESTful API to the DCC DocDB database using 
[Sequelize](https://sequelize.readthedocs.io/en/v3/) and
[Finale](https://github.com/tommybananas/finale).

## Docker container

To build the container, run
```sh
docker build -t cosmicexplorer/rest-dcc:1.1.0 .
````

To add to a docker stack, use:
```yml
    rest-api:
        image: cosmicexplorer/rest-dcc:1.1.0
        init: true
        secrets:
            - mysql_docdbrw_passwd
        networks:
            - default
        deploy:
            replicas: 1
```

## Usage

The sever implements a very simple OAuth2 protected API for GET and POST queries to a [subset of the DCC database tables.](https://github.com/cosmic-explorer/ce-it-infrastructure/tree/master/rest-dcc/dcc_docdb)

Since access is protected by a OAuth2 token, it is not reccomended to try and talk to the API directly. For debugging, it is reccomended to use the [Insomnia Rest Client.](https://insomnia.rest/)

Create a new request in Insomnia and from the `Auth` menu select `OAuth2`. The authorization should be configured as follows, where `seaview.phy.syr.edu` is replaced with the hostname name of the DCC server:
 - `GRANT TYPE` Authorization code
 - `AUTHORIZATION URL` https://seaview.phy.syr.edu/oauth/oauth2/auth
 - `ACCESS TOKEN URL` https://seaview.phy.syr.edu/oauth/oauth2/token
 - `CLIENT ID` dcc-rest-api
 - `CLIENT SECRET` The value of `DCC_REST_SECRET` generated by the [bootstrap-dcc.sh](https://github.com/duncan-brown/ce-it-infrastructure/blob/master/dcc/bootstrap-dcc.sh) script.
 - `REDIRECT URL` https://seaview.phy.syr.edu/rest-dcc/callback
Under `ADVANCED OPTIONS` set:
  - `SCOPE` offline
  - `STATE` clientstate
  - `CREDENTIALS` As Basic Auth Header (Default)

### Get all authors

To create a `GET` request to get all author names, paste the following curl command into the request bar of Insomnia, changing `seaview.phy.syr.edu` to the hostname name of the DCC server:
```sh
curl https://seaview.phy.syr.edu/rest-dcc/Author
```

### Create a new author

To create a `POST` request to add a new author, paste the following curl command into the request bar of Insomnia, changing `seaview.phy.syr.edu` to the hostname name of the DCC server and the request type to `POST`:
```sh
curl https://seaview.phy.syr.edu/rest-dcc/Author -X POST -d '{"FirstName" : "Josh", "LastName" : "Smith", "Active" : "1" }' -H 'content-type: application/json'
```

## References

 - [How to build a secure REST API with node.](https://developer.okta.com/blog/2018/08/21/build-secure-rest-api-with-node) This uses epilogue which is not compatible with Sequelize version 5. The solution is to switch from epilogue to [finale.](https://github.com/tommybananas/finale)
 - [Instructions on running an OAuth2 server](https://www.ory.sh/run-oauth2-server-open-source-api-security/) and [validating tokens](https://www.ory.sh/docs/hydra/integration) from a node.js application.
 - [Running a node.js application in a Docker container.](https://nodejs.org/de/docs/guides/nodejs-docker-webapp/)
 - [node.js Shibboleth authentication](http://www.passportjs.org/packages/passport-uwshib/)
 - [Reverse Proxy for Ory Hydra](https://medium.com/@jose.t.weeks/ory-hydra-in-the-cloud-with-nginx-reverse-proxy-23002fb4a0e3)
